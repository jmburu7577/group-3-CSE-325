@page "/doctor/consultation-notes"
@attribute [Authorize(Roles = "Doctor")]
@using AfyaConnectLite.Models
@using AfyaConnectLite.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IAppointmentService AppointmentService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Consultation Notes - AfyaConnect Lite</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-12">
            <h2>Consultation Notes</h2>
            <p class="text-muted">Manage consultation notes for your patients</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="form-group">
                <label for="appointmentFilter" class="form-label">Filter by Appointment</label>
                <select class="form-select" id="appointmentFilter" @bind="selectedAppointmentId">
                    <option value="">All Appointments</option>
                    @if (appointments != null)
                    {
                        @foreach (var appointment in appointments)
                        {
                            <option value="@appointment.PatientId">
                                @appointment.AppointmentDate.ToString("MMM dd, yyyy") - @appointment.Patient.FirstName @appointment.Patient.LastName
                            </option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="searchTerm" class="form-label">Search Patients</label>
                <input type="text" class="form-control" id="searchTerm" @bind="searchTerm" placeholder="Search by patient name" />
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Consultation Notes</h5>
                    <button class="btn btn-primary btn-sm" @onclick="ShowAddNoteModal">
                        <i class="bi bi-plus"></i> Add Note
                    </button>
                </div>
                <div class="card-body">
                    @if (filteredNotes.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var note in filteredNotes)
                                    {
                                        <tr>
                                            <td>@note.CreatedAt.ToString("MMM dd, yyyy")</td>
                                            <td>
                                                <div>@note.Patient.FirstName @note.Patient.LastName</div>
                                                <small class="text-muted">@note.Patient.Email</small>
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 200px;">
                                                    @note.Notes
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => EditNote(note)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteNote(note)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-journal-text text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No consultation notes found</h5>
                            <p class="text-muted">Start adding consultation notes for your appointments.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    private ClaimsPrincipal User => AuthenticationState?.Result.User ?? new ClaimsPrincipal();

    private ApplicationUser? currentUser;
    private IEnumerable<Appointment> appointments = new List<Appointment>();
    private IEnumerable<ConsultationNote> allNotes = new List<ConsultationNote>();
    private IEnumerable<ConsultationNote> filteredNotes = new List<ConsultationNote>();
    private ConsultationNote newNote = new ConsultationNote();
    private ConsultationNote editingNote = new ConsultationNote();
    private string selectedAppointmentId = string.Empty;
    private string searchTerm = string.Empty;
    private bool showAddNoteModal = false;
    private bool showEditNoteModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
        await LoadAppointments();
        await LoadConsultationNotes();
    }

    private async Task LoadUserData()
    {
        currentUser = await UserManager.GetUserAsync(User);
    }

    private async Task LoadAppointments()
    {
        try
        {
            appointments = await AppointmentService.GetAppointmentsForDoctorAsync(currentUser?.Id ?? string.Empty);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading appointments: {ex.Message}");
        }
    }

    private async Task LoadConsultationNotes()
    {
        try
        {
            allNotes = await AppointmentService.GetConsultationNotesForDoctorAsync(currentUser?.Id ?? string.Empty);
            FilterNotes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading consultation notes: {ex.Message}");
        }
    }

    private void FilterNotes()
    {
        filteredNotes = allNotes.AsEnumerable();

        if (!string.IsNullOrEmpty(selectedAppointmentId))
        {
            filteredNotes = filteredNotes.Where(n => n.PatientId == selectedAppointmentId);
        }

        if (!string.IsNullOrEmpty(searchTerm))
        {
            filteredNotes = filteredNotes.Where(n => 
                n.Patient.FirstName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                n.Patient.LastName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        filteredNotes = filteredNotes.OrderByDescending(n => n.CreatedAt);
    }

    private void ShowAddNoteModal()
    {
        newNote = new ConsultationNote { DoctorId = currentUser?.Id ?? string.Empty, PatientId = string.Empty };
        showAddNoteModal = true;
    }

    private void EditNote(ConsultationNote note)
    {
        editingNote = new ConsultationNote
        {
            Id = note.Id,
            PatientId = note.PatientId,
            Notes = note.Notes,
            DoctorId = note.DoctorId
        };
        showEditNoteModal = true;
    }

    private async Task SaveNote()
    {
        try
        {
            newNote.DoctorId = currentUser?.Id ?? string.Empty;
            newNote.CreatedAt = DateTime.UtcNow;

            await AppointmentService.AddConsultationNoteAsync(newNote);
            
            await LoadConsultationNotes();
            showAddNoteModal = false;
            newNote = new ConsultationNote();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving consultation note: {ex.Message}");
        }
    }

    private async Task UpdateNote()
    {
        try
        {
            editingNote.UpdatedAt = DateTime.UtcNow;
            await AppointmentService.UpdateConsultationNoteAsync(editingNote);
            
            await LoadConsultationNotes();
            showEditNoteModal = false;
            editingNote = new ConsultationNote();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating consultation note: {ex.Message}");
        }
    }

    private async Task DeleteNote(ConsultationNote note)
    {
        try
        {
            await AppointmentService.DeleteConsultationNoteAsync(note.Id);
            await LoadConsultationNotes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting consultation note: {ex.Message}");
        }
    }
}
